<!doctype html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DWG Planner MVP</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: #f5f5f5;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      header {
        background: #2c3e50;
        color: white;
        padding: 20px 0;
        margin-bottom: 30px;
      }
      header h1 {
        text-align: center;
      }
      .nav {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }
      .nav button {
        padding: 10px 20px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .nav button:hover {
        background: #2980b9;
      }
      .section {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .section h2 {
        margin-bottom: 15px;
        color: #2c3e50;
      }
      .form-group {
        margin-bottom: 15px;
      }
      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
      }
      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      .btn {
        padding: 10px 20px;
        background: #27ae60;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .btn:hover {
        background: #219a52;
      }
      .btn-danger {
        background: #e74c3c;
      }
      .btn-danger:hover {
        background: #c0392b;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }
      th {
        background: #f8f9fa;
        font-weight: 600;
      }
      .card {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 15px;
        margin-bottom: 10px;
      }
      .card h3 {
        margin-bottom: 10px;
        color: #2c3e50;
      }
      .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
      }
      .badge-pending {
        background: #f39c12;
        color: white;
      }
      .badge-completed {
        background: #27ae60;
        color: white;
      }
      .badge-high {
        background: #e74c3c;
        color: white;
      }
      .badge-medium {
        background: #3498db;
        color: white;
      }
      .badge-low {
        background: #95a5a6;
        color: white;
      }
      .hidden {
        display: none;
      }
      #login-form {
        max-width: 400px;
        margin: 50px auto;
      }
      .auth-section {
        text-align: center;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>DWG Planner MVP</h1>
    </header>

    <div class="container">
      <div id="auth-section" class="section auth-section">
        <h2>Login</h2>
        <form id="login-form">
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="email" required />
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="password" id="password" required />
          </div>
          <button type="submit" class="btn">Accedi</button>
          <button
            type="button"
            class="btn"
            onclick="register()"
            style="margin-left: 10px; background: #3498db"
          >
            Registrati
          </button>
        </form>
      </div>

      <div id="main-app" class="hidden">
        <div class="nav">
          <button onclick="showSection('projects')">Progetti</button>
          <button onclick="showSection('tasks')">Task</button>
          <button onclick="showSection('dwg')">File DWG</button>
          <button onclick="showSection('mappings')">Mapping</button>
          <button
            onclick="logout()"
            style="margin-left: auto; background: #e74c3c"
          >
            Logout
          </button>
        </div>

        <div id="projects-section" class="section">
          <h2>Progetti</h2>
          <form id="project-form">
            <div class="form-group">
              <label>Nome Progetto</label>
              <input type="text" id="project-name" required />
            </div>
            <div class="form-group">
              <label>Descrizione</label>
              <textarea id="project-desc" rows="2"></textarea>
            </div>
            <button type="submit" class="btn">Crea Progetto</button>
          </form>
          <div id="projects-list" style="margin-top: 20px"></div>
        </div>

        <div id="tasks-section" class="section hidden">
          <h2>Task</h2>
          <form id="task-form">
            <div class="form-group">
              <label>Progetto</label>
              <select id="task-project" required></select>
            </div>
            <div class="form-group">
              <label>Titolo</label>
              <input type="text" id="task-title" required />
            </div>
            <div class="form-group">
              <label>Descrizione</label>
              <textarea id="task-desc" rows="2"></textarea>
            </div>
            <div class="form-group">
              <label>Priorità</label>
              <select id="task-priority">
                <option value="low">Bassa</option>
                <option value="medium" selected>Media</option>
                <option value="high">Alta</option>
              </select>
            </div>
            <button type="submit" class="btn">Crea Task</button>
          </form>
          <div id="tasks-list" style="margin-top: 20px"></div>
        </div>

        <div id="dwg-section" class="section hidden">
          <h2>File DWG</h2>
          <form id="dwg-form">
            <div class="form-group">
              <label>Progetto</label>
              <select id="dwg-project" required></select>
            </div>
            <div class="form-group">
              <label>Nome File</label>
              <input type="text" id="dwg-name" required />
            </div>
            <div class="form-group">
              <label>Versione</label>
              <input type="text" id="dwg-version" value="1.0" />
            </div>
            <button type="submit" class="btn">Carica File DWG</button>
          </form>
          <div id="dwg-list" style="margin-top: 20px"></div>
        </div>

        <div id="mappings-section" class="section hidden">
          <h2>Mapping DWG</h2>
          <form id="mapping-form">
            <div class="form-group">
              <label>File DWG</label>
              <select id="mapping-dwg" required></select>
            </div>
            <div class="form-group">
              <label>Layer</label>
              <input type="text" id="mapping-layer" />
            </div>
            <div class="form-group">
              <label>Handle</label>
              <input type="text" id="mapping-handle" />
            </div>
            <div class="form-group">
              <label>Tag</label>
              <input type="text" id="mapping-tag" />
            </div>
            <div class="form-group">
              <label>Campo Task</label>
              <input type="text" id="mapping-task-field" required />
            </div>
            <div class="form-group">
              <label>Campo Planning</label>
              <input type="text" id="mapping-planning-field" />
            </div>
            <button type="submit" class="btn">Crea Mapping</button>
          </form>
          <div id="mappings-list" style="margin-top: 20px"></div>
        </div>
      </div>
    </div>

    <script>
      let token = localStorage.getItem("token");
      const API_URL = "http://localhost:3000/api";

      if (token) {
        showMainApp();
      }

      document
        .getElementById("login-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const email = document.getElementById("email").value;
          const password = document.getElementById("password").value;

          try {
            const res = await fetch(`${API_URL}/auth/login`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ email, password }),
            });
            const data = await res.json();
            if (res.ok) {
              token = data.token;
              localStorage.setItem("token", token);
              showMainApp();
            } else {
              alert(data.message || "Login fallito");
            }
          } catch (err) {
            alert("Errore di connessione");
          }
        });

      async function register() {
        const email = prompt("Email:");
        const password = prompt("Password:");
        if (!email || !password) return;

        try {
          const res = await fetch(`${API_URL}/auth/register`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password }),
          });
          const data = await res.json();
          if (res.ok) {
            alert("Registrazione completata! Effettua il login.");
          } else {
            alert(data.message || "Registrazione fallita");
          }
        } catch (err) {
          alert("Errore di connessione");
        }
      }

      function logout() {
        token = null;
        localStorage.removeItem("token");
        document.getElementById("auth-section").classList.remove("hidden");
        document.getElementById("main-app").classList.add("hidden");
      }

      function showMainApp() {
        document.getElementById("auth-section").classList.add("hidden");
        document.getElementById("main-app").classList.remove("hidden");
        loadProjects();
        loadProjectsForSelect();
      }

      function showSection(section) {
        ["projects", "tasks", "dwg", "mappings"].forEach((s) => {
          document.getElementById(`${s}-section`).classList.add("hidden");
        });
        document
          .getElementById(`${section}-section`)
          .classList.remove("hidden");

        if (section === "projects") loadProjects();
        if (section === "tasks") loadTasks();
        if (section === "dwg") loadDwgFiles();
        if (section === "mappings") {
          loadDwgFilesForMapping();
          loadMappings();
        }
      }

      async function loadProjects() {
        try {
          const res = await fetch(`${API_URL}/projects`);
          const projects = await res.json();
          const list = document.getElementById("projects-list");
          list.innerHTML = projects
            .map(
              (p) => `
          <div class="card">
            <h3>${p.name}</h3>
            <p>${p.description || ""}</p>
            <p style="color: #7f8c8d; font-size: 12px;">Creato: ${new Date(p.created_at).toLocaleDateString()}</p>
          </div>
        `,
            )
            .join("");
        } catch (err) {
          console.error(err);
        }
      }

      document
        .getElementById("project-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const name = document.getElementById("project-name").value;
          const description = document.getElementById("project-desc").value;

          try {
            const res = await fetch(`${API_URL}/projects`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({ name, description }),
            });
            if (res.ok) {
              document.getElementById("project-form").reset();
              loadProjects();
            } else {
              alert("Errore nella creazione del progetto");
            }
          } catch (err) {
            alert("Errore di connessione");
          }
        });

      async function loadProjectsForSelect() {
        try {
          const res = await fetch(`${API_URL}/projects`);
          const projects = await res.json();
          const options = projects
            .map((p) => `<option value="${p.id}">${p.name}</option>`)
            .join("");
          document.getElementById("task-project").innerHTML = options;
          document.getElementById("dwg-project").innerHTML = options;
        } catch (err) {
          console.error(err);
        }
      }

      async function loadTasks() {
        try {
          const res = await fetch(`${API_URL}/tasks`);
          const tasks = await res.json();
          const list = document.getElementById("tasks-list");
          list.innerHTML = `
          <table>
            <thead><tr><th>Titolo</th><th>Stato</th><th>Priorità</th><th>Progetto</th></tr></thead>
            <tbody>
              ${tasks
                .map(
                  (t) => `
                <tr>
                  <td>${t.title}</td>
                  <td><span class="badge badge-${t.status}">${t.status}</span></td>
                  <td><span class="badge badge-${t.priority}">${t.priority}</span></td>
                  <td>${t.project_id}</td>
                </tr>
              `,
                )
                .join("")}
            </tbody>
          </table>
        `;
        } catch (err) {
          console.error(err);
        }
      }

      document
        .getElementById("task-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const project_id = document.getElementById("task-project").value;
          const title = document.getElementById("task-title").value;
          const description = document.getElementById("task-desc").value;
          const priority = document.getElementById("task-priority").value;

          try {
            const res = await fetch(`${API_URL}/tasks`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({
                project_id,
                title,
                description,
                priority,
              }),
            });
            if (res.ok) {
              document.getElementById("task-form").reset();
              loadTasks();
            } else {
              alert("Errore nella creazione del task");
            }
          } catch (err) {
            alert("Errore di connessione");
          }
        });

      async function loadDwgFiles() {
        try {
          const res = await fetch(`${API_URL}/dwg`);
          const files = await res.json();
          const list = document.getElementById("dwg-list");
          list.innerHTML = files
            .map(
              (f) => `
          <div class="card">
            <h3>${f.name}</h3>
            <p>Versione: ${f.version} | Size: ${f.size || 0} bytes</p>
            <p style="color: #7f8c8d; font-size: 12px;">Caricato: ${new Date(f.uploaded_at).toLocaleDateString()}</p>
          </div>
        `,
            )
            .join("");
        } catch (err) {
          console.error(err);
        }
      }

      document
        .getElementById("dwg-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const project_id = document.getElementById("dwg-project").value;
          const name = document.getElementById("dwg-name").value;
          const version = document.getElementById("dwg-version").value;

          try {
            const res = await fetch(`${API_URL}/dwg`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({ project_id, name, version }),
            });
            if (res.ok) {
              document.getElementById("dwg-form").reset();
              loadDwgFiles();
            } else {
              alert("Errore nel caricamento del file");
            }
          } catch (err) {
            alert("Errore di connessione");
          }
        });

      async function loadDwgFilesForMapping() {
        try {
          const res = await fetch(`${API_URL}/dwg`);
          const files = await res.json();
          document.getElementById("mapping-dwg").innerHTML = files
            .map((f) => `<option value="${f.id}">${f.name}</option>`)
            .join("");
        } catch (err) {
          console.error(err);
        }
      }

      async function loadMappings() {
        try {
          const res = await fetch(`${API_URL}/mappings`);
          const mappings = await res.json();
          const list = document.getElementById("mappings-list");
          list.innerHTML = mappings
            .map(
              (m) => `
          <div class="card">
            <h3>DWG: ${m.dwg_file_id}</h3>
            <p>Layer: ${m.layer || "-"} | Handle: ${m.handle || "-"} | Tag: ${m.tag || "-"}</p>
            <p>Campo Task: ${m.task_field} | Campo Planning: ${m.planning_field || "-"}</p>
          </div>
        `,
            )
            .join("");
        } catch (err) {
          console.error(err);
        }
      }

      document
        .getElementById("mapping-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const dwg_file_id = document.getElementById("mapping-dwg").value;
          const layer = document.getElementById("mapping-layer").value;
          const handle = document.getElementById("mapping-handle").value;
          const tag = document.getElementById("mapping-tag").value;
          const task_field =
            document.getElementById("mapping-task-field").value;
          const planning_field = document.getElementById(
            "mapping-planning-field",
          ).value;

          try {
            const res = await fetch(`${API_URL}/mappings`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({
                dwg_file_id,
                layer,
                handle,
                tag,
                task_field,
                planning_field,
              }),
            });
            if (res.ok) {
              document.getElementById("mapping-form").reset();
              loadMappings();
            } else {
              alert("Errore nella creazione del mapping");
            }
          } catch (err) {
            alert("Errore di connessione");
          }
        });
    </script>
  </body>
</html>
